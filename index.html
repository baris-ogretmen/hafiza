import React, { useState, useEffect, useRef, useCallback } from 'react';
import { Play, RotateCcw, Trophy, Brain, Volume2, VolumeX } from 'lucide-react';

// Ses frekansları (müzikal notalar)
const FREQUENCIES = {
  green: 329.63, // E4
  red: 261.63,   // C4
  yellow: 293.66, // D4
  blue: 392.00,  // G4
  error: 110.00  // A2 (Hata sesi)
};

const COLORS = [
  { id: 'green', color: 'bg-green-500', active: 'bg-green-300', shadow: 'shadow-green-500/50' },
  { id: 'red', color: 'bg-red-500', active: 'bg-red-300', shadow: 'shadow-red-500/50' },
  { id: 'yellow', color: 'bg-yellow-400', active: 'bg-yellow-200', shadow: 'shadow-yellow-400/50' },
  { id: 'blue', color: 'bg-blue-500', active: 'bg-blue-300', shadow: 'shadow-blue-500/50' }
];

export default function MemoryGame() {
  const [sequence, setSequence] = useState([]);
  const [playingIdx, setPlayingIdx] = useState(null); // Şu an yanan ışığın indexi
  const [userStep, setUserStep] = useState(0);
  const [gameState, setGameState] = useState('idle'); // idle, playing, showing, gameover
  const [score, setScore] = useState(0);
  const [highScore, setHighScore] = useState(0);
  const [soundEnabled, setSoundEnabled] = useState(true);
  const [flashColor, setFlashColor] = useState(null); // Görsel yanıp sönme durumu

  // Web Audio API Context
  const audioCtxRef = useRef(null);

  useEffect(() => {
    // Audio Context'i başlat (kullanıcı etkileşimi gerekebilir, bu yüzden lazy init yapacağız)
    return () => {
      if (audioCtxRef.current) audioCtxRef.current.close();
    };
  }, []);

  const playTone = (colorId, length = 0.3) => {
    if (!soundEnabled) return;

    if (!audioCtxRef.current) {
      audioCtxRef.current = new (window.AudioContext || window.webkitAudioContext)();
    }

    const ctx = audioCtxRef.current;
    if (ctx.state === 'suspended') ctx.resume();

    const osc = ctx.createOscillator();
    const gainNode = ctx.createGain();

    osc.type = colorId === 'error' ? 'sawtooth' : 'sine';
    osc.frequency.setValueAtTime(FREQUENCIES[colorId], ctx.currentTime);
    
    gainNode.gain.setValueAtTime(0.1, ctx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + length);

    osc.connect(gainNode);
    gainNode.connect(ctx.destination);
    osc.start();
    osc.stop(ctx.currentTime + length);
  };

  const startGame = () => {
    setSequence([]);
    setScore(0);
    setUserStep(0);
    setGameState('showing');
    addToSequence([]);
  };

  const addToSequence = (currentSeq) => {
    const colors = ['green', 'red', 'yellow', 'blue'];
    const randomColor = colors[Math.floor(Math.random() * 4)];
    const newSeq = [...currentSeq, randomColor];
    setSequence(newSeq);
    setScore(newSeq.length - 1); // Skor tur sayısı gibidir
    
    // Sırayı oynat
    setTimeout(() => {
      playSequence(newSeq);
    }, 1000);
  };

  const playSequence = async (seq) => {
    setGameState('showing');
    setUserStep(0);
    
    for (let i = 0; i < seq.length; i++) {
      await new Promise(resolve => setTimeout(resolve, 300)); // Bekleme
      const color = seq[i];
      setFlashColor(color);
      playTone(color);
      await new Promise(resolve => setTimeout(resolve, 500)); // Işık yanma süresi
      setFlashColor(null);
    }
    
    setGameState('playing');
  };

  const handleColorClick = (colorId) => {
    if (gameState !== 'playing') return;

    // Tıklama efekti ve ses
    playTone(colorId, 0.2);
    setFlashColor(colorId);
    setTimeout(() => setFlashColor(null), 200);

    // Doğruluk kontrolü
    if (colorId !== sequence[userStep]) {
      // YANLIŞ
      setGameState('gameover');
      playTone('error', 0.8);
      if (score > highScore) {
        setHighScore(score);
        localStorage.setItem('memory-highscore', score);
      }
      return;
    }

    // DOĞRU
    const nextStep = userStep + 1;
    if (nextStep === sequence.length) {
      // Tur tamamlandı
      setGameState('showing');
      setTimeout(() => {
        addToSequence(sequence);
      }, 1000);
    } else {
      setUserStep(nextStep);
    }
  };

  // LocalStorage'dan rekoru çek
  useEffect(() => {
    const saved = localStorage.getItem('memory-highscore');
    if (saved) setHighScore(parseInt(saved));
  }, []);

  return (
    <div className="min-h-screen bg-slate-900 text-white flex flex-col items-center justify-center p-4 font-sans select-none">
      
      {/* Başlık ve Skorlar */}
      <div className="w-full max-w-md flex flex-col items-center mb-8 gap-4">
        <div className="flex items-center gap-2 mb-2">
            <Brain className="w-8 h-8 text-purple-400" />
            <h1 className="text-3xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
            Hafıza Ustası
            </h1>
        </div>
        
        <div className="flex justify-between w-full px-6 py-3 bg-slate-800 rounded-2xl shadow-lg border border-slate-700">
          <div className="flex flex-col items-center">
            <span className="text-xs text-slate-400 uppercase tracking-wider">Skor</span>
            <span className="text-2xl font-mono font-bold text-white">{score}</span>
          </div>
          <div className="flex flex-col items-center">
            <span className="text-xs text-slate-400 uppercase tracking-wider">Rekor</span>
            <div className="flex items-center gap-1">
              <Trophy className="w-4 h-4 text-yellow-500" />
              <span className="text-2xl font-mono font-bold text-yellow-500">{highScore}</span>
            </div>
          </div>
        </div>
      </div>

      {/* Oyun Alanı */}
      <div className="relative mb-12">
        {/* Arkaplan halkası */}
        <div className="absolute inset-0 bg-slate-800 rounded-full blur-2xl opacity-50 transform scale-110"></div>
        
        <div className="grid grid-cols-2 gap-4 p-4 bg-slate-800 rounded-full shadow-2xl border-4 border-slate-700 relative z-10">
          {COLORS.map((btn) => (
            <button
              key={btn.id}
              onClick={() => handleColorClick(btn.id)}
              disabled={gameState === 'showing' || gameState === 'gameover'}
              className={`
                w-24 h-24 sm:w-32 sm:h-32 rounded-2xl transition-all duration-150 transform
                ${btn.color}
                ${flashColor === btn.id ? `brightness-150 scale-95 ${btn.shadow} shadow-lg ring-4 ring-white/50` : 'hover:brightness-110'}
                ${gameState === 'showing' ? 'cursor-not-allowed' : 'active:scale-90'}
                border-b-4 border-black/20
              `}
              aria-label={`${btn.id} renk`}
            />
          ))}
          
          {/* Merkez Durum Göstergesi */}
          <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
            <div className="w-16 h-16 bg-slate-900 rounded-full border-4 border-slate-700 flex items-center justify-center shadow-xl">
               {gameState === 'showing' && <div className="w-3 h-3 bg-red-500 rounded-full animate-ping" />}
               {gameState === 'playing' && <div className="w-3 h-3 bg-green-500 rounded-full" />}
            </div>
          </div>
        </div>
      </div>

      {/* Kontroller */}
      <div className="flex flex-col gap-4 items-center w-full max-w-xs z-20">
        
        {gameState === 'idle' && (
          <button 
            onClick={startGame}
            className="w-full py-4 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 transition-transform active:scale-95"
          >
            <Play className="w-6 h-6" /> Oyuna Başla
          </button>
        )}

        {gameState === 'gameover' && (
          <div className="w-full animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div className="bg-red-500/10 border border-red-500/50 rounded-xl p-4 mb-4 text-center">
              <h2 className="text-xl font-bold text-red-400 mb-1">Oyun Bitti!</h2>
              <p className="text-slate-300">Skorun: {score}</p>
            </div>
            <button 
              onClick={startGame}
              className="w-full py-4 bg-slate-700 hover:bg-slate-600 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 transition-transform active:scale-95 border border-slate-600"
            >
              <RotateCcw className="w-6 h-6" /> Tekrar Dene
            </button>
          </div>
        )}

        {gameState === 'playing' && (
            <div className="text-slate-400 text-sm animate-pulse">Sıra sende!</div>
        )}
        
        {gameState === 'showing' && (
            <div className="text-slate-400 text-sm">İzle...</div>
        )}

        <button 
          onClick={() => setSoundEnabled(!soundEnabled)}
          className="mt-4 p-2 text-slate-500 hover:text-slate-300 transition-colors"
          title="Sesi Aç/Kapat"
        >
          {soundEnabled ? <Volume2 className="w-6 h-6" /> : <VolumeX className="w-6 h-6" />}
        </button>

      </div>
    </div>
  );
}

